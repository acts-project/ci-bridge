name: GitLab Job Triggered Workflow

on:
  repository_dispatch:
    types: [gitlab-job-finished]

jobs:
  gitlab-triggered-job:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main  # Always use main branch as requested
          
      - name: Display GitLab job information
        run: |
          echo "ğŸš€ GitLab job has finished!"
          echo "ğŸ“Š Job Status: ${{ github.event.client_payload.job_status }}"
          echo "ğŸ”§ Job Name: ${{ github.event.client_payload.job_name }}"
          echo "ğŸ†” Job ID: ${{ github.event.client_payload.job_id }}"
          echo "ğŸ”— Job URL: ${{ github.event.client_payload.job_url }}"
          echo "ğŸ“ Project: ${{ github.event.client_payload.project_name }}"
          echo "ğŸŒ¿ Branch: ${{ github.event.client_payload.ref }}"
          echo "ğŸ“ Commit SHA: ${{ github.event.client_payload.commit_sha }}"
          echo "ğŸ”„ Pipeline ID: ${{ github.event.client_payload.pipeline_id }}"
          echo "ğŸŒ Pipeline URL: ${{ github.event.client_payload.pipeline_url }}"
          echo "â° Created: ${{ github.event.client_payload.created_at }}"
          echo "â–¶ï¸ Started: ${{ github.event.client_payload.started_at }}"
          echo "â¹ï¸ Finished: ${{ github.event.client_payload.finished_at }}"
          echo "â“ Allow Failure: ${{ github.event.client_payload.allow_failure }}"
          
      - name: Install the latest version of uv
        uses: astral-sh/setup-uv@v6
        
      - name: Run tests (triggered by GitLab)
        run: uv run nox
        
      - name: Custom actions based on GitLab job status
        run: |
          JOB_STATUS="${{ github.event.client_payload.job_status }}"
          JOB_NAME="${{ github.event.client_payload.job_name }}"
          ALLOW_FAILURE="${{ github.event.client_payload.allow_failure }}"
          
          echo "Processing GitLab job: $JOB_NAME"
          
          if [[ "$JOB_STATUS" == "success" ]]; then
            echo "âœ… GitLab job succeeded - running success actions"
            # Add your success-specific commands here
            # Example: deploy, send notifications, update documentation, etc.
            
          elif [[ "$JOB_STATUS" == "failed" ]]; then
            if [[ "$ALLOW_FAILURE" == "true" ]]; then
              echo "âš ï¸ GitLab job failed but failure is allowed - running neutral actions"
              # Handle allowed failures differently
            else
              echo "âŒ GitLab job failed - running failure actions"
              # Add your failure-specific commands here
              # Example: rollback, send alerts, create issues, etc.
              exit 1
            fi
            
          elif [[ "$JOB_STATUS" == "canceled" ]]; then
            echo "ğŸš« GitLab job was canceled"
            # Handle canceled jobs
            
          else
            echo "â“ Unknown job status: $JOB_STATUS"
          fi
          
      - name: Notify completion
        run: |
          echo "ğŸ‰ GitHub workflow triggered by GitLab job '${{ github.event.client_payload.job_name }}' has completed!"
          echo "Original GitLab job: ${{ github.event.client_payload.job_url }}"